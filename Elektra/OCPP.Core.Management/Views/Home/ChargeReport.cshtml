@using Microsoft.AspNetCore.Mvc.Localization
@model OCPP.Core.Management.Models.ChargeReportViewModel
@inject IViewLocalizer Localizer

<style>
    .compact-table th, .compact-table td {
        padding: 2px 5px !important;
        margin: 0 !important;
    }
</style>

@{
    ViewData["Title"] = Localizer["Charge Report"];
}

<h1>@ViewData["Title"]</h1>

<p>Report from @Model.StartTime.ToShortDateString() to @Model.StopTime.ToShortDateString()</p>

<form method="get" asp-action="ChargeReport" class="form-inline">
    <div class="form-group mb-2">
        <label for="startTime" class="sr-only">@Localizer["Start Time"]</label>
        <input type="date" id="startTime" name="startTime" class="form-control" value="@Model.StartTime.ToString("yyyy-MM-dd")" />
    </div>
    <div class="form-group mx-sm-3 mb-2">
        <label for="stopTime" class="sr-only">@Localizer["Stop Time"]</label>
        <input type="date" id="stopTime" name="stopTime" class="form-control" value="@Model.StopTime.ToString("yyyy-MM-dd")" />
    </div>
    <button type="submit" class="btn btn-primary mb-2">@Localizer["Submit"]</button>

    <div class="btn-group mb-2 ml-2">
        <a href="@Url.Action("ChargeReport", new { startTime = new DateTime(DateTime.Now.Year, 1, 1).ToString("yyyy-MM-dd"), stopTime = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss") })" class="btn btn-secondary">@Localizer["Year to Date"]</a>
        <a href="@Url.Action("ChargeReport", new { startTime = new DateTime(DateTime.Now.Year - 1, 1, 1).ToString("yyyy-MM-dd"), stopTime = new DateTime(DateTime.Now.Year - 1, 12, 31, 23, 59, 59).ToString("yyyy-MM-ddTHH:mm:ss") })" class="btn btn-secondary">@Localizer["Previous Year"]</a>
        <a href="@Url.Action("ChargeReport", new { startTime = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddMonths(-1).ToString("yyyy-MM-dd"), stopTime = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddSeconds(-1).ToString("yyyy-MM-ddTHH:mm:ss") })" class="btn btn-secondary">@Localizer["Previous Month"]</a>
        <a href="@Url.Action("ChargeReport", new { startTime = DateTime.Now.AddDays(-(int)DateTime.Now.DayOfWeek - 7).ToString("yyyy-MM-dd"), stopTime = DateTime.Now.AddDays(-(int)DateTime.Now.DayOfWeek).AddSeconds(-1).ToString("yyyy-MM-ddTHH:mm:ss") })" class="btn btn-secondary">@Localizer["Previous Week"]</a>
    </div>

    <div class="ml-auto">
        <table class="table table-bordered compact-table" style="width: auto; margin: 0;">
            <thead>
                <tr>
                    <th></th>
                    <th class="text-center">@Localizer["CSV"]</th>
                    <th class="text-center">@Localizer["XLSX"]</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@Localizer["Summary"]</td>
                    <td class="text-center p-1">
                        <a href="@Url.Action("ChargeReportCsv", new { startTime = Model.StartTime.ToString("yyyy-MM-dd"), stopTime = Model.StopTime.ToString("yyyy-MM-dd") })" title="@Localizer["Export Summary (CSV)"]">
                            <i class="fas fa-file-csv"></i>
                        </a>
                    </td>
                    <td class="text-center p-1">
                        <a href="@Url.Action("ChargeReportXlsx", new { startTime = Model.StartTime.ToString("yyyy-MM-dd"), stopTime = Model.StopTime.ToString("yyyy-MM-dd") })" title="@Localizer["Export Summary (XLSX)"]">
                            <i class="fas fa-file-excel"></i>
                        </a>
                    </td>
                </tr>
                <tr>
                    <td>@Localizer["Detail"]</td>
                    <td class="text-center p-1">
                        <a href="@Url.Action("AllTransactionsCsv", new { startTime = Model.StartTime.ToString("yyyy-MM-dd"), stopTime = Model.StopTime.ToString("yyyy-MM-dd") })" title="@Localizer["Export All Transactions (CSV)"]">
                            <i class="fas fa-file-csv"></i>
                        </a>
                    </td>
                    <td class="text-center p-1">
                        <a href="@Url.Action("AllTransactionsXlsx", new { startTime = Model.StartTime.ToString("yyyy-MM-dd"), stopTime = Model.StopTime.ToString("yyyy-MM-dd") })" title="@Localizer["Export All Transactions (XLSX)"]">
                            <i class="fas fa-file-excel"></i>
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</form>

@foreach (var group in Model.Groups)
{
    <h2>@group.GroupName</h2>
    <table id="dtChargeTags" class="table table-striped table-bordered table-sm table-hover" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th class="th-sm">@Localizer["Tag Name"]</th>
                <th class="th-sm">@Localizer["Energy (kWh)"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var tag in group.Tags)
            {
                var totalEnergy = tag.Transactions
                .Where(t => t.Energy.HasValue)
                .Sum(t => t.Energy.Value);

                <tr>
                    <td>@tag.TagName</td>
                    <td>@(Math.Round(totalEnergy, 2)) kWh</td>
                </tr>
            }
        </tbody>
    </table>
}
